# 👶 パパになるための禁煙

男性妊活 × 禁煙サポート Web アプリケーション

禁煙の動機を「赤ちゃんのため」に紐づけることで、長期継続をサポートします。
科学的根拠に基づいた精子への効果を可視化し、禁煙のモチベーションを維持します。

---

## 機能一覧

| 画面 | 機能 |
|------|------|
| 🏠 ダッシュボード | 禁煙日数・節約金額のリアルタイム表示、マイルストーン進捗、本日のチェック状況 |
| 🚭 禁煙トラッカー | 「吸いたい」衝動ログ（強度・トリガー・我慢成否）、マイルストーン一覧（時刻は日本時間表示） |
| 🌿 妊活チェック | 亜鉛・葉酸・睡眠・運動・ストレスの日次チェックリスト |
| 💌 日記 | 未来の子どもへのメッセージ投稿・閲覧 |
| ⚙️ 設定 | 禁煙開始日・1日の本数・タバコ価格の設定、Discord通知設定 |
| 👫 パートナー共有 | 共有コード生成・パートナーとの双方向メッセージ |

---

## 技術スタック

| 区分 | 技術・サービス |
|------|--------------|
| フロントエンド | [Streamlit](https://streamlit.io/) |
| バックエンド / DB | [Supabase](https://supabase.com/)（無料枠：500MB・50,000行） |
| デプロイ | [Streamlit Community Cloud](https://streamlit.io/cloud)（無料） |
| グラフ | Plotly |
| 通知 | Discord Webhook（無料・オプション） |

---

## セットアップ

### 1. リポジトリのクローン

```bash
git clone <your-repo-url>
cd smoke
```

### 2. Supabase の設定

既存プロジェクトへの同居、または新規プロジェクトどちらでも対応しています。
テーブルはすべて `smoke` スキーマ内に作成されるため、他プロジェクトのテーブルと衝突しません。

#### 2-1. テーブルの作成

プロジェクトの **SQL Editor** を開き、`schema.sql` の内容を貼り付けて実行します。

テーブル作成後、PostgREST のスキーマキャッシュをリフレッシュしてください。

**Supabase ダッシュボード → Settings → API → 「Reload schema cache」をクリック**

> テーブルを新規追加したときに `PGRST205: Could not find the table '...' in the schema cache` が出た場合も、このリフレッシュで解消されます。

#### 2-2. `smoke` スキーマの公開（必須）

デフォルトでは `public` スキーマしか公開されていないため、以下の設定が必要です。

1. Supabase ダッシュボード → **Settings → API**
2. **「Exposed schemas」** に `smoke` を追加
3. **「Save」** をクリック

> この設定をしないと API からのアクセスが拒否されます。

#### 2-3. スキーマへのロール権限付与（必須）

`smoke` スキーマは新規作成のため、Supabase の各 DB ロールに対して権限が**自動付与されません**。
設定しないと、以下のエラーが発生します。

```
permission denied for schema smoke (code: 42501)
```

**SQL Editor** で以下の 3 つを順番に実行してください。

**① スキーマへの USAGE 権限**

```sql
grant usage on schema smoke to anon;
grant usage on schema smoke to authenticated;
grant usage on schema smoke to service_role;
```

**② 既存テーブルへの操作権限**

```sql
grant select, insert, update, delete
on all tables in schema smoke
to anon, authenticated, service_role;
```

**③ 今後作成するテーブルへの自動適用（重要）**

これを設定しないと、新規テーブルを追加するたびに同じエラーが発生します。

```sql
alter default privileges in schema smoke
grant select, insert, update, delete
on tables to anon, authenticated, service_role;
```

### 3. 環境変数の設定

`.env.example` をコピーして `.env` を作成し、Supabase の接続情報を記入します。

```bash
cp .env.example .env
```

`.env` を編集：

```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key

# オプション：Discord Webhook通知を使う場合
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/...

# オプション：パートナー共有URLの自動生成に使う場合
APP_URL=https://your-app.streamlit.app
```

> **接続情報の確認場所：** Supabase ダッシュボード → Project Settings → API

### 4. パッケージのインストール

```bash
pip install -r requirements.txt
```

### 5. アプリの起動

```bash
streamlit run app.py
```

ブラウザで `http://localhost:8501` が開きます。

---

## 初回セットアップ

アプリ起動後、まず **設定** 画面（サイドバーの「4_設定」）から以下を入力してください。

- 禁煙開始日
- 1日に吸っていた本数
- 1箱の価格

設定を保存するとダッシュボードに禁煙日数・節約金額が表示されます。

---

## 使い方

### 🏠 ダッシュボード（ホーム）

起動すると最初に表示されるメイン画面です。

- **禁煙期間・節約金額・本数** — 禁煙開始日から現在までをリアルタイムで表示します。
- **赤ちゃん貯金の推移グラフ** — 節約金額の累積をグラフで確認できます。禁煙2日目以降に表示されます。
- **次のマイルストーン** — 精子への科学的効果が得られる次の節目と残り日数を表示します。
- **本日のチェック状況** — 妊活チェックの入力状況をひと目で確認できます。

---

### 🚭 禁煙トラッカー

「吸いたい」と感じたときに記録する画面です。

1. **衝動の記録**
   - 衝動の強さ（1〜5）・きっかけ・結果（我慢 or 喫煙）を選択して「記録する」をクリックします。
   - きっかけは選択肢から選べます。「その他」を選ぶと自由にテキスト入力できます。
   - 気持ちを落ち着かせるために未来の子どもへのひとことも書けます。

2. **衝動ヒートマップ**
   - 3件以上記録されると、時間帯×曜日の分布をヒートマップで確認できます。
   - 色が濃い時間帯が「衝動が起きやすいパターン」です。事前に対策を立てましょう。

3. **衝動ログ履歴**
   - 記録回数・我慢成功数・成功率をサマリーで確認できます。
   - 直近10件のログが一覧表示されます。

4. **マイルストーン一覧**
   - 達成済みのマイルストーンと、まだ達成していないマイルストーン（残り日数付き）を一覧で確認できます。

---

### 🌿 妊活チェック

毎日の生活習慣を記録する画面です。就寝前に入力するのがおすすめです。

1. **本日のチェックリスト**
   - 亜鉛・葉酸の摂取、睡眠時間、運動、ストレスレベルを入力して「保存する」をクリックします。
   - 保存後に本日の **妊活スコア（0〜100点）** が表示されます。
     - 80点以上 → 素晴らしい
     - 50点以上 → 良いペース
     - 50点未満 → もう少し頑張りましょう

2. **生活習慣スコアの推移グラフ**
   - 2日以上記録されると、日ごとのスコアを棒グラフで確認できます。
   - 緑：80点以上 / 橙：50点以上 / 赤：50点未満で色分けされています。
   - 破線が目標ライン（80点）です。

3. **記録履歴**
   - 直近7日間の記録を一覧で確認できます。

---

### 💌 日記

未来の子どもへのメッセージを残す画面です。

- 気分（ハッピー・普通・落ち込み気味）を選んでメッセージを書いて「投稿する」をクリックします。
- 過去に投稿したメッセージは一覧で読み返すことができます。

---

### ⚙️ 設定

禁煙に関する基本情報を設定する画面です。

- 禁煙開始日・1日の本数・1箱の価格・1箱の本数を入力して「保存する」をクリックします。
- 設定内容はダッシュボードの節約金額計算に反映されます。

**Discord通知設定：**

- `DISCORD_WEBHOOK_URL` が設定されている場合、通知ON/OFFのトグルとテスト送信ボタンが表示されます。
- 通知タイミング：マイルストーン達成時、妊活チェック未入力時（1セッション1回）。

---

### 👫 パートナー共有

禁煙の進捗をパートナーに共有する画面です。

1. 「共有コードを生成する」をクリックすると8文字の共有コードが生成されます。
2. 生成されたURL（`https://your-app.streamlit.app/?share=XXXXXXXX`）をパートナーに送ります。
3. パートナーがURLを開くと **閲覧専用ダッシュボード** が表示されます。
   - 禁煙期間・節約金額・マイルストーン・妊活チェック状況を確認できます。
   - パートナーは応援メッセージを送ることができます。
4. このページでパートナーからのメッセージを確認・返信できます。
5. 「共有を停止する」をクリックすると共有コードが無効になります。

---

## ファイル構成

```
smoke/
├── app.py                  # ホーム（ダッシュボード）・パートナービュー分岐
├── pages/
│   ├── 1_禁煙トラッカー.py  # 衝動ログ・マイルストーン
│   ├── 2_妊活チェック.py    # デイリーチェックリスト
│   ├── 3_日記.py           # 未来の子どもへのメッセージ
│   ├── 4_設定.py           # 禁煙設定・タバコ情報・Discord通知設定
│   └── 5_パートナー共有.py  # 共有コード生成・双方向メッセージ
├── utils/
│   ├── supabase_client.py  # DB操作関数
│   ├── calculations.py     # 禁煙日数・節約金額計算
│   ├── milestones.py       # マイルストーン定義（科学的根拠）
│   └── discord_notifier.py # Discord Webhook通知
├── schema.sql              # Supabase テーブル作成 SQL
├── requirements.txt        # 依存パッケージ
├── .env.example            # 環境変数テンプレート
└── README.md
```

---

## Streamlit Community Cloud へのデプロイ

1. GitHub にリポジトリを push（`.env` は **push しない**）
2. [Streamlit Community Cloud](https://share.streamlit.io/) にログイン
3. 「New app」→ リポジトリ・ブランチ・`app.py` を選択
4. 「Advanced settings」→ Secrets に環境変数を設定：

```toml
SUPABASE_URL = "https://your-project.supabase.co"
SUPABASE_KEY = "your-anon-key"

# オプション：Discord Webhook通知を使う場合
DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/..."

# オプション：パートナー共有URLの自動生成に使う場合
APP_URL = "https://your-app.streamlit.app"
```

5. 「Deploy」をクリック

---

## Discord Webhook通知の設定

マイルストーン達成時・妊活チェック未入力時に Discord へ通知できます。完全無料で、セットアップは約1分です。

### 1. Webhook URL の取得

1. Discord で通知を受け取りたいサーバー（またはチャンネル）を開く
2. チャンネル名を右クリック → **「チャンネルの編集」**
3. **「連携サービス」** → **「ウェブフック」** → **「新しいウェブフック」**
4. 任意の名前（例：`パパ禁煙`）を入力 → **「ウェブフック URL をコピー」**

### 2. 環境変数に設定

**ローカル（`.env`）：**

```env
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/xxxxxxxxxx/xxxxxxxx
```

**Streamlit Community Cloud（Secrets）：**

```toml
DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/xxxxxxxxxx/xxxxxxxx"
```

### 3. 動作確認

`DISCORD_WEBHOOK_URL` を設定した状態でアプリを起動すると、**⚙️ 設定** 画面の「Discord通知設定」セクションに **「テストメッセージを送信」** ボタンが表示されます。クリックして Discord に届くことを確認してください。

> 環境変数が未設定の場合はボタンは表示されず、設定手順のガイドが表示されます。

### 通知タイミング

| タイミング | 内容 |
|-----------|------|
| マイルストーン達成時 | 達成したマイルストーン名と説明を通知 |
| ダッシュボードを開いたとき（妊活チェック未入力の場合） | 入力を促すリマインダーを通知。同一セッション内では1回のみ送信 |

> リマインダーは定時ではなく「アプリを開いたタイミング」で送信されます。毎晩ログインする習慣があれば実質的なリマインダーとして機能します。

> `DISCORD_WEBHOOK_URL` を設定しない場合は通知機能が無効になるだけで、アプリは正常に動作します。

---

## マイルストーン一覧

禁煙日数に応じて、科学的根拠に基づくマイルストーンが解除されます。

| 日数 | マイルストーン |
|------|--------------|
| 1日 | 血中一酸化炭素濃度が正常値に回復 |
| 3日 | ニコチンが体内からほぼ排出 |
| 7日 | 精子の酸化ストレスが低下し始める |
| 14日 | 精子の運動率が改善し始める |
| 30日 | 精子の DNA 損傷リスクが低下 |
| 60日 | 精子の形態・数が改善傾向に |
| 74日 | 精子の新サイクル完了（約74日サイクル） |
| 90日 | 精子の質が顕著に改善 |
| 180日 | 精子の質が非喫煙者と同等レベルに |
| 365日 | 心臓病リスクが喫煙者の半分に |

---

## 実装済み機能（フェーズ別）

### Phase 1（完了）
- 基本5画面（ダッシュボード・禁煙トラッカー・妊活チェック・日記・設定）

### Phase 2（完了）
- 衝動ヒートマップ（時間帯×曜日グラフ）
- 節約金額の累積グラフ（ダッシュボード）
- 生活習慣スコアの推移グラフ（妊活チェック）

### Phase 3（完了）
- Discord Webhook通知（マイルストーン達成・妊活チェックリマインダー）
- パートナー共有機能（URLパラメータ方式・双方向メッセージ）
- PWA対応メタタグ（iOSホーム画面への追加）

### その他の改善（完了）
- 全タイムスタンプ表示を日本標準時（JST）に統一
- 衝動トリガーに「その他（自由入力）」を追加
