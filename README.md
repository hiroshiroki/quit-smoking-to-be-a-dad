# 👶 パパになるための禁煙

男性妊活 × 禁煙サポート Web アプリケーション

禁煙の動機を「赤ちゃんのため」に紐づけることで、長期継続をサポートします。
科学的根拠に基づいた精子への効果を可視化し、禁煙のモチベーションを維持します。

---

## 機能一覧

| 画面 | 機能 |
|------|------|
| 🏠 ダッシュボード | 禁煙日数・節約金額のリアルタイム表示、マイルストーン進捗、本日のチェック状況 |
| 🚭 禁煙トラッカー | 「吸いたい」衝動ログ（強度・トリガー・我慢成否）、マイルストーン一覧 |
| 🌿 妊活チェック | 亜鉛・葉酸・睡眠・運動・ストレスの日次チェックリスト |
| 💌 日記 | 未来の子どもへのメッセージ投稿・閲覧 |
| ⚙️ 設定 | 禁煙開始日・1日の本数・タバコ価格の設定 |

---

## 技術スタック

| 区分 | 技術・サービス |
|------|--------------|
| フロントエンド | [Streamlit](https://streamlit.io/) |
| バックエンド / DB | [Supabase](https://supabase.com/)（無料枠：500MB・50,000行） |
| デプロイ | [Streamlit Community Cloud](https://streamlit.io/cloud)（無料） |
| グラフ | Plotly |
| 通知 | LINE Notify（Phase 3で追加予定） |

---

## セットアップ

### 1. リポジトリのクローン

```bash
git clone <your-repo-url>
cd smoke
```

### 2. Supabase の設定

既存プロジェクトへの同居、または新規プロジェクトどちらでも対応しています。
テーブルはすべて `smoke` スキーマ内に作成されるため、他プロジェクトのテーブルと衝突しません。

#### 2-1. テーブルの作成

プロジェクトの **SQL Editor** を開き、`schema.sql` の内容を貼り付けて実行します。

#### 2-2. `smoke` スキーマの公開（必須）

デフォルトでは `public` スキーマしか公開されていないため、以下の設定が必要です。

1. Supabase ダッシュボード → **Settings → API**
2. **「Exposed schemas」** に `smoke` を追加
3. **「Save」** をクリック

> この設定をしないと API からのアクセスが拒否されます。

#### 2-3. スキーマへのロール権限付与（必須）

`smoke` スキーマは新規作成のため、Supabase の各 DB ロールに対して権限が**自動付与されません**。
設定しないと、以下のエラーが発生します。

```
permission denied for schema smoke (code: 42501)
```

**SQL Editor** で以下の 3 つを順番に実行してください。

**① スキーマへの USAGE 権限**

```sql
grant usage on schema smoke to anon;
grant usage on schema smoke to authenticated;
grant usage on schema smoke to service_role;
```

**② 既存テーブルへの操作権限**

```sql
grant select, insert, update, delete
on all tables in schema smoke
to anon, authenticated, service_role;
```

**③ 今後作成するテーブルへの自動適用（重要）**

これを設定しないと、新規テーブルを追加するたびに同じエラーが発生します。

```sql
alter default privileges in schema smoke
grant select, insert, update, delete
on tables to anon, authenticated, service_role;
```

### 3. 環境変数の設定

`.env.example` をコピーして `.env` を作成し、Supabase の接続情報を記入します。

```bash
cp .env.example .env
```

`.env` を編集：

```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key
```

> **接続情報の確認場所：** Supabase ダッシュボード → Project Settings → API

### 4. パッケージのインストール

```bash
pip install -r requirements.txt
```

### 5. アプリの起動

```bash
streamlit run app.py
```

ブラウザで `http://localhost:8501` が開きます。

---

## 初回セットアップ

アプリ起動後、まず **設定** 画面（サイドバーの「4_設定」）から以下を入力してください。

- 禁煙開始日
- 1日に吸っていた本数
- 1箱の価格

設定を保存するとダッシュボードに禁煙日数・節約金額が表示されます。

---

## 使い方

### 🏠 ダッシュボード（ホーム）

起動すると最初に表示されるメイン画面です。

- **禁煙期間・節約金額・本数** — 禁煙開始日から現在までをリアルタイムで表示します。
- **赤ちゃん貯金の推移グラフ** — 節約金額の累積をグラフで確認できます。禁煙2日目以降に表示されます。
- **次のマイルストーン** — 精子への科学的効果が得られる次の節目と残り日数を表示します。
- **本日のチェック状況** — 妊活チェックの入力状況をひと目で確認できます。

---

### 🚭 禁煙トラッカー

「吸いたい」と感じたときに記録する画面です。

1. **衝動の記録**
   - 衝動の強さ（1〜5）・きっかけ・結果（我慢 or 喫煙）を選択して「記録する」をクリックします。
   - 気持ちを落ち着かせるために未来の子どもへのひとことも書けます。

2. **衝動ヒートマップ**
   - 3件以上記録されると、時間帯×曜日の分布をヒートマップで確認できます。
   - 色が濃い時間帯が「衝動が起きやすいパターン」です。事前に対策を立てましょう。

3. **衝動ログ履歴**
   - 記録回数・我慢成功数・成功率をサマリーで確認できます。
   - 直近10件のログが一覧表示されます。

4. **マイルストーン一覧**
   - 達成済みのマイルストーンと、まだ達成していないマイルストーン（残り日数付き）を一覧で確認できます。

---

### 🌿 妊活チェック

毎日の生活習慣を記録する画面です。就寝前に入力するのがおすすめです。

1. **本日のチェックリスト**
   - 亜鉛・葉酸の摂取、睡眠時間、運動、ストレスレベルを入力して「保存する」をクリックします。
   - 保存後に本日の **妊活スコア（0〜100点）** が表示されます。
     - 80点以上 → 素晴らしい
     - 50点以上 → 良いペース
     - 50点未満 → もう少し頑張りましょう

2. **生活習慣スコアの推移グラフ**
   - 2日以上記録されると、日ごとのスコアを棒グラフで確認できます。
   - 緑：80点以上 / 橙：50点以上 / 赤：50点未満で色分けされています。
   - 破線が目標ライン（80点）です。

3. **記録履歴**
   - 直近7日間の記録を一覧で確認できます。

---

### 💌 日記

未来の子どもへのメッセージを残す画面です。

- 気分（ハッピー・普通・落ち込み気味）を選んでメッセージを書いて「投稿する」をクリックします。
- 過去に投稿したメッセージは一覧で読み返すことができます。

---

### ⚙️ 設定

禁煙に関する基本情報を設定する画面です。

- 禁煙開始日・1日の本数・1箱の価格・1箱の本数を入力して「保存する」をクリックします。
- 設定内容はダッシュボードの節約金額計算に反映されます。

---

## ファイル構成

```
smoke/
├── app.py                  # ホーム（ダッシュボード）
├── pages/
│   ├── 1_禁煙トラッカー.py  # 衝動ログ・マイルストーン
│   ├── 2_妊活チェック.py    # デイリーチェックリスト
│   ├── 3_日記.py           # 未来の子どもへのメッセージ
│   └── 4_設定.py           # 禁煙設定・タバコ情報
├── utils/
│   ├── supabase_client.py  # DB操作関数
│   ├── calculations.py     # 禁煙日数・節約金額計算
│   └── milestones.py       # マイルストーン定義（科学的根拠）
├── schema.sql              # Supabase テーブル作成 SQL
├── requirements.txt        # 依存パッケージ
├── .env.example            # 環境変数テンプレート
└── README.md
```

---

## Streamlit Community Cloud へのデプロイ

1. GitHub にリポジトリを push（`.env` は **push しない**）
2. [Streamlit Community Cloud](https://share.streamlit.io/) にログイン
3. 「New app」→ リポジトリ・ブランチ・`app.py` を選択
4. 「Advanced settings」→ Secrets に環境変数を設定：

```toml
SUPABASE_URL = "https://your-project.supabase.co"
SUPABASE_KEY = "your-anon-key"
```

5. 「Deploy」をクリック

---

## マイルストーン一覧

禁煙日数に応じて、科学的根拠に基づくマイルストーンが解除されます。

| 日数 | マイルストーン |
|------|--------------|
| 1日 | 血中一酸化炭素濃度が正常値に回復 |
| 3日 | ニコチンが体内からほぼ排出 |
| 7日 | 精子の酸化ストレスが低下し始める |
| 14日 | 精子の運動率が改善し始める |
| 30日 | 精子の DNA 損傷リスクが低下 |
| 60日 | 精子の形態・数が改善傾向に |
| 74日 | 精子の新サイクル完了（約74日サイクル） |
| 90日 | 精子の質が顕著に改善 |
| 180日 | 精子の質が非喫煙者と同等レベルに |
| 365日 | 心臓病リスクが喫煙者の半分に |

---

## 今後の実装予定

### Phase 2（完了）
- 衝動ヒートマップ（時間帯×曜日グラフ）
- 節約金額の累積グラフ（ダッシュボード）
- 生活習慣スコアの推移グラフ（妊活チェック）

### Phase 3
- LINE Notify 連携（毎朝リマインド・マイルストーン通知）
- PWA 対応（スマホのホーム画面に追加可能）
- パートナー共有機能
