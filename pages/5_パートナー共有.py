"""
ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å…±æœ‰ç”»é¢ - å…±æœ‰ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»åŒæ–¹å‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
"""
import os

import streamlit as st

from utils.calculations import to_jst_str
from utils.supabase_client import (
    get_partner_share,
    create_partner_share,
    deactivate_partner_share,
    add_partner_message,
    get_partner_messages,
)

st.set_page_config(page_title="ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å…±æœ‰", page_icon="ğŸ‘«", layout="centered")

st.title("ğŸ‘« ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å…±æœ‰")
st.caption("ç¦ç…™ã®é€²æ—ã‚’ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨å…±æœ‰ã—ã¾ã—ã‚‡ã†")

# â”€â”€â”€ å…±æœ‰URLã®ãƒ™ãƒ¼ã‚¹å–å¾— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app_url = os.environ.get("APP_URL", "").rstrip("/")

# â”€â”€â”€ ç¾åœ¨ã®å…±æœ‰çŠ¶æ…‹ã‚’å–å¾— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
share = get_partner_share()

# â”€â”€â”€ å…±æœ‰ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»åœæ­¢UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("---")
st.subheader("ğŸ”— å…±æœ‰è¨­å®š")

if share:
    share_code = share["share_code"]

    if app_url:
        share_url = f"{app_url}/?share={share_code}"
        st.success(f"âœ… å…±æœ‰ã‚³ãƒ¼ãƒ‰: **{share_code}**")
        st.markdown("**ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«ä»¥ä¸‹ã®URLã‚’å…±æœ‰ã—ã¦ãã ã•ã„ï¼š**")
        st.code(share_url, language=None)
        st.caption("ã“ã®URLã‚’é–‹ãã¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒç¦ç…™ã®é€²æ—ã‚’é–²è¦§ã§ãã¾ã™ã€‚")
    else:
        st.success(f"âœ… å…±æœ‰ã‚³ãƒ¼ãƒ‰: **{share_code}**")
        st.info(
            "ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚ã‚‰ã†ã«ã¯ã€ã‚¢ãƒ—ãƒªã®URLã®æœ«å°¾ã« "
            f"`?share={share_code}` ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚\n\n"
            "ä¾‹: `https://your-app.streamlit.app/?share={share_code}`\n\n"
            "ç’°å¢ƒå¤‰æ•° `APP_URL` ã«ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆURLã‚’è¨­å®šã™ã‚‹ã¨URLãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚"
        )

    if st.button("ğŸ›‘ å…±æœ‰ã‚’åœæ­¢ã™ã‚‹", width='stretch', type="secondary"):
        deactivate_partner_share()
        st.success("å…±æœ‰ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚")
        st.rerun()
else:
    st.info("å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã€ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«ç¦ç…™ã®é€²æ—ã‚’è¦‹ã›ã¾ã—ã‚‡ã†ã€‚")
    if st.button("ğŸ”‘ å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹", width='stretch', type="primary"):
        share = create_partner_share()
        st.rerun()

# â”€â”€â”€ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—ä¿¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if share:
    share_code = share["share_code"]

    st.markdown("---")
    st.subheader("ğŸ’¬ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ 
    with st.form("send_message_form", clear_on_submit=True):
        message_text = st.text_area(
            "ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
            placeholder="ä»Šæ—¥ã‚‚é ‘å¼µã£ã¦ã„ã‚‹ã‚ˆï¼",
            max_chars=500,
        )
        send_btn = st.form_submit_button("é€ä¿¡ã™ã‚‹ ğŸ“¨", width='stretch')

    if send_btn and message_text.strip():
        add_partner_message(share_code, "user", message_text.strip())
        st.success("âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼")
        st.rerun()
    elif send_btn:
        st.warning("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§
    messages = get_partner_messages(share_code)
    if messages:
        st.markdown("---")
        st.subheader("ğŸ“© ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´")
        for msg in messages:
            sent_at = to_jst_str(msg["sent_at"])  # JST ã«å¤‰æ›ã—ã¦è¡¨ç¤º
            if msg["sender"] == "user":
                with st.chat_message("user"):
                    st.markdown(msg["message"])
                    st.caption(f"ã‚ãªãŸ Â· {sent_at}")
            else:
                with st.chat_message("assistant"):
                    st.markdown(msg["message"])
                    st.caption(f"ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ Â· {sent_at}")
    else:
        st.info("ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šã¾ã—ã‚‡ã†ï¼")

# â”€â”€â”€ ä½¿ã„æ–¹èª¬æ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("---")
with st.expander("ğŸ“– ä½¿ã„æ–¹"):
    st.markdown("""
**ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å…±æœ‰ã®ä½¿ã„æ–¹ï¼š**

1. **å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ** â†’ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«å…±æœ‰URLã‚’é€ã‚‹
2. ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒå…±æœ‰URLã‚’é–‹ãã¨ **é–²è¦§å°‚ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰** ãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - ç¦ç…™æœŸé–“ãƒ»ç¯€ç´„é‡‘é¡ãƒ»ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãƒ»å¦Šæ´»ãƒã‚§ãƒƒã‚¯çŠ¶æ³ã‚’ç¢ºèªã§ãã‚‹
3. ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ **å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸** ã‚’é€ã‚‹ã“ã¨ãŒã§ãã‚‹
4. ã“ã®ãƒšãƒ¼ã‚¸ã§ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã§ãã‚‹

**ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã«ã¤ã„ã¦ï¼š**
- å…±æœ‰ã‚’åœæ­¢ã™ã‚‹ã¨æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ã«ãªã‚Šã¾ã™
- ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¯é–²è¦§ã¨å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®ã¿å¯èƒ½ã§ã™ï¼ˆãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã¯ã§ãã¾ã›ã‚“ï¼‰
""")
